# fluentd/conf/fluent.conf
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>
<source>
  @type http
  port 9880
  bind 0.0.0.0
  cors_allow_origins ["*"]
</source>
<filter docker.**>
  @type concat
  key log
  stream_identity_key container_id
  multiline_start_regexp /^([0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])( |T)(2[0-3]|[01][0-9]):[0-5][0-9]:[0-5][0-9])|([0-9]{2} [A-z]{3} (2[0-3]|[01][0-9]):[0-5][0-9]:[0-5][0-9])|([0-9]{2}\/(0[1-9]|1[0-2])\/(0[1-9]|[1-2][0-9]|3[0-1]) (2[0-3]|[01][0-9]):[0-5][0-9]:[0-5][0-9])/
  separator ""
  flush_interval 0
</filter>
<filter docker.**>
  @type record_transformer
  <record>
    layer "PLATFORM"
  </record>
</filter>

<match {**simplesensor**,sensor.*}>
  @type copy
  <store>
    @type file
    path /fluentd/log/bigdataincidentanalytics/pipeline/sensor/sensor.%Y-%m-%d.%H
    append true
    <format>
      @type json
    </format>
    <buffer>
      timekey 1h
      timekey_use_utc true
      timekey_wait 70s
    </buffer>
    <inject>
      time_key fluentd_time
      time_type string
      time_format %Y-%m-%dT%H:%M:%S.%NZ
      localtime false
      tag_key log_name
    </inject>
  </store>
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix fluentd
    logstash_dateformat %Y%m%d
    include_tag_key true
    include_timestamp true
    type_name fluentd
    tag_key @log_name
    default_elasticsearch_version 6.5.4
    <buffer tag>
      @type memory # or file
      flush_thread_count 4
      flush_interval 2s
    </buffer>
  </store>
</match>

<match docker.mqtt>
  @type copy
  <store>
    @type file
    path /fluentd/log/bigdataincidentanalytics/pipeline/mqtt/mqtt.%Y-%m-%d.%H
    append true
    <format>
      @type json
    </format>
    <buffer>
      timekey 1h
      timekey_use_utc true
      timekey_wait 70s
    </buffer>
    <inject>
      time_key fluentd_time
      time_type string
      time_format %Y-%m-%dT%H:%M:%S.%NZ
      localtime false
      tag_key log_name
    </inject>
  </store>
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix fluentd
    logstash_dateformat %Y%m%d
    include_tag_key true
    include_timestamp true
    type_name fluentd
    tag_key @log_name
    default_elasticsearch_version 6.5.4
    <buffer tag>
      @type memory # or file
      flush_thread_count 4
      flush_interval 2s
    </buffer>
  </store>
</match>

<match {**flink**,**jobmanager**}>
  @type copy
  <store>
    @type file
    path /fluentd/log/bigdataincidentanalytics/pipeline/flink/flink.%Y-%m-%d.%H
    append true
    <format>
      @type json
    </format>
    <buffer>
      timekey 1h
      timekey_use_utc true
      timekey_wait 70s
    </buffer>
    <inject>
      time_key fluentd_time
      time_type string
      time_format %Y-%m-%dT%H:%M:%S.%NZ
      localtime false
      tag_key log_name
    </inject>
  </store>
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix fluentd
    logstash_dateformat %Y%m%d
    include_tag_key true
    include_timestamp true
    type_name fluentd
    tag_key @log_name
    default_elasticsearch_version 6.5.4
    <buffer tag>
      @type memory # or file
      flush_thread_count 4
      flush_interval 2s
    </buffer>
  </store>
</match>

<match **nodered**>
  @type copy
  <store>
    @type file
    path /fluentd/log/bigdataincidentanalytics/pipeline/nodered/nodered.%Y-%m-%d.%H
    append true
    <format>
      @type json
    </format>
    <buffer>
      timekey 1h
      timekey_use_utc true
      timekey_wait 70s
      flush_interval 10s
    </buffer>
    <inject>
      time_key fluentd_time
      time_type string
      time_format %Y-%m-%dT%H:%M:%S.%NZ
      localtime false
      tag_key log_name
    </inject>
  </store>
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix fluentd
    logstash_dateformat %Y%m%d
    include_tag_key true
    include_timestamp true
    type_name fluentd
    tag_key @log_name
    default_elasticsearch_version 6.5.4
    <buffer tag>
      @type memory # or file
      flush_thread_count 4
      flush_interval 2s
    </buffer>
  </store>
</match>

<match **nifi**>
  @type copy
  <store>
    @type file
    path /fluentd/log/bigdataincidentanalytics/pipeline/nifi/nifi.%Y-%m-%d.%H
    append true
    <format>
      @type json
    </format>
    <buffer>
      timekey 1h
      timekey_use_utc true
      timekey_wait 70s
      flush_interval 10s
    </buffer>
    <inject>
      time_key fluentd_time
      time_type string
      time_format %Y-%m-%dT%H:%M:%S.%NZ
      localtime false
      tag_key log_name
    </inject>
  </store>
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix fluentd
    logstash_dateformat %Y%m%d
    include_tag_key true
    include_timestamp true
    type_name fluentd
    tag_key @log_name
    default_elasticsearch_version 6.5.4
    <buffer tag>
      @type memory # or file
      flush_thread_count 4
      flush_interval 2s
    </buffer>
  </store>
</match>

<match {**namenode**,**datanode**,**resourcemanager**,**nodemanager**}>
  @type copy
  <store>
    @type file
    path /fluentd/log/bigdataincidentanalytics/pipeline/hadoop/hadoop.%Y-%m-%d.%H
    append true
    <format>
      @type json
    </format>
    <buffer>
      timekey 1h
      timekey_use_utc true
      timekey_wait 70s
      flush_interval 10s
    </buffer>
    <inject>
      time_key fluentd_time
      time_type string
      time_format %Y-%m-%dT%H:%M:%S.%NZ
      localtime false
      tag_key log_name
    </inject>
  </store>
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix fluentd
    logstash_dateformat %Y%m%d
    include_tag_key true
    include_timestamp true
    type_name fluentd
    tag_key @log_name
    default_elasticsearch_version 6.5.4
    <buffer tag>
      @type memory # or file
      flush_thread_count 4
      flush_interval 2s
    </buffer>
  </store>
</match>

<match **spark**>
  @type copy
  <store>
    @type file
    path /fluentd/log/bigdataincidentanalytics/pipeline/spark/spark.%Y-%m-%d.%H
    append true
    <format>
      @type json
    </format>
    <buffer>
      timekey 1h
      timekey_use_utc true
      timekey_wait 70s
      flush_interval 10s
    </buffer>
    <inject>
      time_key fluentd_time
      time_type string
      time_format %Y-%m-%dT%H:%M:%S.%NZ
      localtime false
      tag_key log_name
    </inject>
  </store>
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix fluentd
    logstash_dateformat %Y%m%d
    include_tag_key true
    include_timestamp true
    type_name fluentd
    tag_key @log_name
    default_elasticsearch_version 6.5.4
    <buffer tag>
      @type memory # or file
      flush_thread_count 4
      flush_interval 2s
    </buffer>
  </store>
</match>


<match *.**>
  @type copy
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix fluentd
    logstash_dateformat %Y%m%d
    include_tag_key true
    include_timestamp true
    type_name fluentd
    tag_key @log_name
    default_elasticsearch_version 6.5.4
    <buffer tag>
      @type memory # or file
      flush_thread_count 4
      flush_interval 2s
    </buffer>
  </store>
  <store>
    @type file
    path /fluentd/log/bigdataincidentanalytics
    compress gzip
    append true
  </store>
</match>
